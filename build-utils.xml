<?xml version="1.0" ?>
<project name="build-utils">
	<dirname property="build-utils.dir" file="${ant.file.build-utils}" />
	
	<import file="${build-utils.dir}/ivy/ivy-macros.xml" />

	<macrodef name="getArtifactName">
		<attribute name="artifactUrl" 
			description="The URL to retrieve the name from." />
		
		<attribute name="username" default="${username}"
			description="The username to login with." />
		
		<attribute name="password" default="${password}"
			description="The password to login with." />
		
		<attribute name="property" description="The property to put the artifact name into." />
		
		<sequential>
			<get dest="${build-utils.dir}/filename" usetimestamp="true"
				src="@{artifactUrl}" username="@{username}" password="@{password}" />
			<loadfile property="@{property}" srcfile="${build-utils.dir}/filename" />
		</sequential>
	</macrodef>
	
	<macrodef name="getArtifact" description="Retrieves an artifact from a Hudson build.">
		<attribute name="dest" description="The file or directory to store the artifact in. If this is a directory, the original artifact name will be used." />
		
		<attribute name="buildUrl"
			description="The URL to the build to get the artifact name from." />
		
		<attribute name="partialName"
			description="Part of the artifact name to retrieve. This allows selecting a particular artifact from a build that produces multiple things." />
		
		<attribute name="artifactUrl" default="@{buildUrl}/api/xml?xpath=/*/artifact/relativePath[contains(text(),'@{partialName}')]/text()"
			description="The exact URL to retrieve the name from. Normally calculated from the URL and partial name" />

		<attribute name="username" default="${username}"
			description="The username to login with." />
		
		<attribute name="password" default="${password}"
			description="The password to login with." />
		
		<sequential>
			<getArtifactName property="build-utils.artifactName" artifacturl="@{artifactUrl}" username="@{username}" password="@{password}" />
			<get dest="@{dest}" usetimestamp="true"
				src="@{buildUrl}/artifact/${build-utils.artifactName}"
				username="${username}" password="${password}"/>
		</sequential>
	</macrodef>
	
	<macrodef name="getBuildInfo" description="Retrieves the XML build information from Hudson.">
		<attribute name="dest" description="The file to store the build details in." />
		
		<attribute name="buildUrl"
			description="The URL to the build to get the details for." />
		
		<attribute name="username" default="${username}"
			description="The username to login with." />
		
		<attribute name="password" default="${password}"
			description="The password to login with." />
		
		<sequential>
			<get dest="@{dest}" usetimestamp="true"
				src="@{buildUrl}/api/xml"
				username="${username}" password="${password}"/>
		</sequential>
	</macrodef>
</project>
